apiVersion: kind.x-k8s.io/v1alpha4
kind: Cluster
metadata:
  name: capi-management
spec:
  # Configure the management cluster with enough resources for CAPI controllers
  nodes:
  - role: control-plane
    kubeadmConfigPatches:
    - |
      kind: InitConfiguration
      nodeRegistration:
        kubeletExtraArgs:
          node-labels: "ingress-ready=true"
    extraPortMappings:
    - containerPort: 80
      hostPort: 80
      protocol: TCP
    - containerPort: 443
      hostPort: 443
      protocol: TCP
    # Increase resource limits for CAPI workloads
    extraMounts:
    - hostPath: /var/run/docker.sock
      containerPath: /var/run/docker.sock
  
  # Add worker node for better resource distribution
  - role: worker
  
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:
        enable-admission-plugins: NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook
    controllerManager:
      extraArgs:
        enable-hostpath-provisioner: "true"
  
  # Configure networking
  networking:
    # Use a different CIDR to avoid conflicts with workload clusters
    podSubnet: "10.244.0.0/16"
    serviceSubnet: "10.96.0.0/12"
    disableDefaultCNI: false