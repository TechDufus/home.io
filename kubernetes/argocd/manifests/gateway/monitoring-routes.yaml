# HTTPRoutes and ReferenceGrant for Monitoring Stack
# Consolidates Grafana, Prometheus, and Alertmanager routes

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: grafana-route
  namespace: traefik
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: monitoring-stack
    app.kubernetes.io/managed-by: argocd
spec:
  parentRefs:
    - name: lab-gateway
      namespace: traefik
  hostnames:
    - grafana.techdufus.com
  rules:
    - backendRefs:
        - name: kube-prometheus-stack-grafana
          namespace: monitoring
          port: 80

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: prometheus-route
  namespace: traefik
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/part-of: monitoring-stack
    app.kubernetes.io/managed-by: argocd
spec:
  parentRefs:
    - name: lab-gateway
      namespace: traefik
  hostnames:
    - prometheus.techdufus.com
  rules:
    - backendRefs:
        - name: prometheus-kube-prometheus-prometheus
          namespace: monitoring
          port: 9090

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: alertmanager-route
  namespace: traefik
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/part-of: monitoring-stack
    app.kubernetes.io/managed-by: argocd
spec:
  parentRefs:
    - name: lab-gateway
      namespace: traefik
  hostnames:
    - alertmanager.techdufus.com
  rules:
    - backendRefs:
        - name: prometheus-kube-prometheus-alertmanager
          namespace: monitoring
          port: 9093

---
# Single ReferenceGrant for all monitoring services
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: monitoring-cross-namespace-grant
  namespace: monitoring
  labels:
    app.kubernetes.io/part-of: monitoring-stack
    app.kubernetes.io/managed-by: argocd
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: traefik
  to:
    - group: ""
      kind: Service
      name: kube-prometheus-stack-grafana
    - group: ""
      kind: Service
      name: prometheus-kube-prometheus-prometheus
    - group: ""
      kind: Service
      name: prometheus-kube-prometheus-alertmanager
